# 3. Create and Test Domain.jl

To get experience with Julia and modules, we will build first an application where we can register and retrieve persons.

You start with creating the sub-module file `Domain.jl`.

Then you define in Domain.jl:
- the objects Address and Person,
- the enumerator AddressType with the values EMAIL and WORK,
- the local function create_key, which will create a unique key based on the time of creation and address.
- the objects that are accessible by other modules.

Finally, you define test code in the file `runtests.jl`.

### Contents

```@contents
Pages = ["chapter3.md"]
```

## Domain.jl - Domain Objects

On the Domain page, you define the custom data structures that make-up your domain.

To define a data structure and type, use the keyword `struct`. The body consists of the fields of the data structure. A struct is a non-mutable object unless you use the preceding keyword `mutable.`

Use constructors to define standard values. It simplifies the creating op the object.

```julia
module Domain #1

using Dates #2

export Person, Address, AddressType, EMAIL, WORK #3

# local function to generate an unique id
create_key(name::String) = string(hash(name * string(time()))) #4

# enumerated type for an address.
@enum AddressType EMAIL WORK #5

struct Address #6
  id::String
  created::DateTime
  address_type::AddressType
  address::String
  #constructors
  Address(address_type, address) = new(create_key(address), now(), address_type, address)
end # Address

struct Person #7
  id::String
  created::DateTime
  name::String
  addresses::Array{Address, 1}
  #constructors
  Person(name) = new(create_key(name), name, [])
  Person(name, addresses) = new(create_key(name), now(), name, addresses)
end

end

```
\#1 Module names start with a capital letter. See [Blue: a Style Guide for Julia](https://github.com/invenia/BlueStyle)

\#2 If you need date functions like time(), date(), or now() you have the load the Dates package.

\#3 Define what other modules default see when they want to use the sub-module Domain.

\#4 We use the hash-function to generate an unique id. You use `*` to concatenate Strings in Julia.

\#5 The AddressTypes that you allow in an Address object.

\#6 The structure of the Address datatype. The constructor `create` allows the programmer to only specify the AddressType and the address. The fields `id` and `created` are generated by Julia code.

\#7 The Person datatype. The fields `id` and `created` are generated by Julia code. When you don't specify an address, the software creates an empty array. Later on, you can add addresses using the `push!` function.


## Activity 3.1 - Create the File Domain.jl in the src-folder

Prerequisites (activities in chapter 2)
- Activity 2.1 - Setup the Development Environment.
- Activity 2.2 - Create the Accounts module.
- Activity 2.3 - Create a Repository on GitHub.

| Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | Go to the `~/.julia/dev/Accounts` folder|  |
| 3 | Remove all Taps in the right pane.|  |
| 4 | Right click on: src |  |
| 5 | Select: `New file` |  |
| 6 | Type: `Domain.jl` | A file that represents a module starts with a capital letter.  |
| 7 | Press: <Enter> | A new document appears in the pane next to the navigation pane. |

In the navigation pane you see the next folders and files:

```
·µ•üìÅ Accounts
  ·µ•üìÅ src
     üìÑ Accounts.jl
     üìÑ Domain.jl
```

## Activity 3.2 - Pasting the Domain Code into Domain.jl

- The previous activity 3.1

| Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | Select the code from the section [Domain.jl-Domain-objects](#Domain.jl-Domain-objects-1) |  |
| 2 | Copy the code to the clipboard |  |
| 3 | Paste the code in the file Domain.jl |  |
| 4 | Ctrl-S | Save the file. |


## Dependencies

All dependencies of your module should be declared in the file `Build.toml` under the section `[deps]`. We use the now()-function in the code and is defined in Dates. Dates is a sub-module of Julia and should be loaded in your code by `using Dates`.

When someone adds our module Accounts it automatically loads the right dependency versions.

```
name = "Accounts"
uuid = "a1b4bf14-7ec5-4e42-8992-fb1d0e08b0e4"
authors = ["Rob Bontekoe <rbontekoe@appligate.nl> and contributors"]
version = "0.1.0"

[deps]
Dates = "ade2ca70-3891-5945-98fb-dc099432e06a"

[compat]
julia = "1"

[extras]
Test = "8dfed614-e22c-5e08-85e1-65c5234f0b40"

[targets]
test = ["Test"]
```
*Fig 3.1*

## Activity 3.3 - Adding Dates as Dependency

#### Prerequisites
- The previous activity 3.2

You automatically add dependencies to the file `Build.toml` when you switch to your Accounts environment.

| Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | jullia> ] | Activate the package manager. |
| 2 | pkg> activate . | Go to the Accounts environment. |
| 3 | (Accounts) pkg> status | Show Accounts loaded packages (dependencies) |
| 4 | (Accounts) pkg> add Dates | Add the Dates module. |
| 5 | (Accounts) pkg> status | Shows your dependencies. |

```
Project Accounts v0.1.0
Status `~/.julia/dev/Accounts/Project.toml`
  [ade2ca70] Dates
```

| Step | Action | Comment |
| :--- | :--- | :--- |
| 6 | Press: BackSpace | return to the Julia prompt. |



## test_domain.jl

```
using Pkg; Pkg.activate(".")

import Accounts: Domain

using .Domain

rob_address_email = Address(EMAIL, "rbontekoe@appligate.nl")
rob_address_work = Address(WORK,
  """
  Landweg 74
  3833VM LEUSDEN
  The Netherlands
  """
)

addresses = [rob_address_email, rob_address_work]

rob = Person("Rob Bontekoe", addresses)

email_address = filter(x -> x.address_type == EMAIL, rob.addresses)

println(email_address[1].address)
```

## Activity 3.4 - Testing your Code

Most of the time you put code want to test parts of your application in a test file.

#### Prerequisites
- The previous activity 3.3

Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | Create the file test_domain.jl |  |
| 2 | Copy the test_domain.jl code into the file | See: [test_domain.jl](#test_domain.jl-1) |
| 3 | Ctrl-S | Save the file. |  |
| 4 | Select the first line |  |
| 5 | Shift-Enter | The line will execute. |
| 6 | Repeat until the last line. |  |
| 7 | Ctrl-Enter | The cursor stays on the current line. |


## runtests.jl

It is even better to put you test code in the file runtest.jl. The file is located in the folder test.

```
using Accounts
using Test

import Accounts: Domain
using .Domain

@testset "Domain.jl" begin
    rob_address_email = Address(EMAIL, "rbontekoe@appligate.nl")
    rob = Person("Rob Bontekoe", [rob_address_email])
    email_addresses = filter(x -> x.address_type == EMAIL, rob.addresses)
    @test email_addresses[1].address == "rbontekoe@appligate.nl"
end
```

## Activity 3.5 - runtests.jl

#### Prerequisites
- The previous activity 3.4

Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | $ atom . | Start Atom/Juno.
| 2 | Select the folder: `test` | Open the folder with runtests.jl. |

```
·µ•üìÅ Accounts
   üìÅ src
  ·µ•üìÅ test
     üìÑ runtests.jl
```

Step | Action | Comment |
| :--- | :--- | :--- |
| 3 | Open file: `runtests.jl` | Open the file.|
| 4 | Copy and paste the code from section runtests.jl | See: [runtests.jl](#runtests.jl-1) |
| 5 | Ctrl-S | Save the file. |
| 6 | julia> ] | Activate the package manager. |
| 7 | pkg> activate . | Activate the Accounts environment. |
| 8 | (Accounts) Pkg> st | Check whether Dates is loaded. See activity 3.3. |
| 9 | (Accounts) Pkg>  test Accounts | Run the test code. The result is: |

```
Test Summary: | Pass  Total
Domain.jl     |    1      1
    Testing Accounts tests passed
```
