# 3. Create and Test Domain.jl

To get experience with Julia and modules, we will build an application where we can register and retrieve persons.

You start with creating the sub-module file Domain.jl. Then you define in Domain.jl:
- the objects Address and Person.
- the enumerator AddressType with the values EMAIL and WORK.
- the local function create_key, which will create a unique key based on the time of creation and address.
- the objects that are accessible by other modules.

Finally, you define the test code in the file runtests.jl.

### Contents

```@contents
Pages = ["chapter3.md"]
```

## Domain.jl - Domain Objects

On the Domain page, you define the custom data structures that make-up your domain.

To define a data structure and type, use the keyword `struct`. The body consists of the fields of the data structure. A struct is a non-mutable object unless you precede it with the keyword `mutable`.

Use constructors to define standard values. It simplifies the creating of an object.

```julia
module Domain #1

using Dates #2

export Person, Address, AddressType, EMAIL, WORK #3

# local function to generate an unique id
create_key(name::String) = string(hash(name * string(time()))) #4

# enumerated type for an address.
@enum AddressType EMAIL WORK #5

struct Address #6
  id::String
  created::DateTime
  address_type::AddressType
  address::String
  #constructors
  Address(address_type, address) = new(create_key(address), now(), address_type, address)
end # Address

struct Person #7
  id::String
  created::DateTime
  name::String
  addresses::Array{Address, 1}
  #constructors
  Person(name) = new(create_key(name), name, [])
  Person(name, addresses) = new(create_key(name), now(), name, addresses)
end

end

```
\#1 Module names start with a capital letter. See the [Blue: a Style Guide for Julia](https://github.com/invenia/BlueStyle).

\#2 If you need date functions like time(), date(), or now() you have to load the Dates package.

\#3 With the keyword `export` you define what elements are default available to users.

\#4 We use the hash function to generate a unique id. You use `*` to concatenate Strings in Julia. The function `string` converts the date-time value to a String value.

\#5 The AddressTypes that you allow in an Address object.

\#6 The structure of the `Address` datatype. The constructor `Address(address_type, address)` allows the user to only specify the AddressType and the address. The values for the fields `id` and `created` are generated by the Julia code.

\#7 The Person datatype. The values for the fields `id` and `created` are generated by Julia code. When you don't specify an address, the software creates an empty array. Later on, you can add addresses using the `push!` function.


## Activity 3.1 - Create the File Domain.jl in the src-folder

#### Prerequisites (activities in chapter 2)
- Activity 2.1 - Setup the Development Environment.
- Activity 2.2 - Create the Accounts module.
- Activity 2.3 - Create a Repository on GitHub.

In this activity you:
- Create the file Domain.jl.

| Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | Go to the `~/.julia/dev/Accounts` folder|  |
| 2 | Right click on: src |  |
| 3 | Select: `New file` |  |
| 4| Type: `Domain.jl` | A file that represents a module starts with a capital letter.  |
| 5 | Press: <Enter> | A new document appears in the pane next to the navigation pane. |

In the navigation pane you see the next folders and files:

```
·µ•üìÅ Accounts
  ·µ•üìÅ src
     üìÑ Accounts.jl
     üìÑ Domain.jl
```

## Activity 3.2 - Pasting the Domain Code into Domain.jl

In this activity you:
- Add the Domain code to the file Domain.jl.
- Save the file.

#### Prerequisites
- The previous activity 3.1

| Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | Select the code from the section [Domain.jl-Domain-objects](#Domain.jl-Domain-Objects-1) |  |
| 2 | Ctrl-C | Copy the code to the clipboard. |
| 3 | Paste the code in the file Domain.jl |  |
| 4 | Ctrl-S | Save the file. |

## Modified Accounts.jl

```
module Accounts

include("Domain.jl"); using .Domain #1

end
```
\#1 the function `include` loads the code of the specified file. `using .Domain` activates the module.
The dot refers to a sub-module of Accounts. The `;` separates the two Julia statements.

## Activity 3.3 - Update Accounts.jl

In this activity you declare Domain as a sub-module of Accounts.

#### Prerequisites
- The previous activity 3.2

| Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | Open `Accounts.jl` |  |
| 2 | Delete all lines |  |
| 3 | Copy the code [Modified Accounts.jl](#Modified-Accounts.jl-1) into the file |  |
| 4 | Ctrl-S | Save the file. |

## Dependencies

You declare all dependencies of your module in the file `Project.toml` under the section `[deps]`. The `now()`-function belongs to `Dates` module. Dates is a Julia module and you load with `using Dates`.

```
name = "Accounts"
uuid = "a1b4bf14-7ec5-4e42-8992-fb1d0e08b0e4"
authors = ["Rob Bontekoe <rbontekoe@appligate.nl> and contributors"]
version = "0.1.0"

[deps]
Dates = "ade2ca70-3891-5945-98fb-dc099432e06a"

[compat]
julia = "1"

[extras]
Test = "8dfed614-e22c-5e08-85e1-65c5234f0b40"

[targets]
test = ["Test"]
```

## Activity 3.4 - Adding Dates as Dependency

In this activity you will:
- Activate the `Accounts` environment.
- Add the dependency `Dates` to the environment and `Project.toml`.
- Inspect the status of the active environment.

You automatically add dependencies to the file `Project.toml` when you switch to the `Accounts` environment.

#### Prerequisites
- The previous activity 3.3

| Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | Open the Julia REPL  | Juno > Open REPL. |
| 2 | Press: <Enter> | Start Julia. |
| 3 | jullia> ] | Type `]` to activate the package manager. |
| 4 | pkg> activate . | Activate the Accounts environment. |
| 5 | (Accounts) pkg> status | Show Accounts loaded packages (dependencies) |
| 6 | (Accounts) pkg> add Dates | Add the Dates module. |
| 7 | (Accounts) pkg> st | Show your dependencies. You can abbreviate your commands. Use the arrow-up button to retrieve previous commands. |

```
Project Accounts v0.1.0
Status `~/.julia/dev/Accounts/Project.toml`
  [ade2ca70] Dates
```

| Step | Action | Comment |
| :--- | :--- | :--- |
| 6 | Press: BackSpace | Return to the Julia prompt. |


## test_domain.jl

```
using Pkg; Pkg.activate(".")

import Accounts: Domain

using .Domain

donald_email = Address(EMAIL, "donald@duckcity.com")
donald_work = Address(WORK,
  """
  Donalds Hardware Store
  attn. Donald Duck
  1190 Seven Seas Dr
  FL 32830 Lake Buena Vista
  USA
  """
)

addresses = [donald_email, donald_work]

donald = Person("Donald Duck", addresses)

email_address = filter(x -> x.address_type == EMAIL, donald.addresses)

println(email_address[1].address)
```

## Activity 3.5 - Testing your Code

Most of the time, you put the code that you want to test in a test file.

#### Prerequisites
- The previous activity 3.4

Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | Create the file test_domain.jl |  |
| 2 | Copy the test_domain.jl code into the file | See: [test_domain.jl](#test_domain.jl-1) |
| 3 | Ctrl-S | Save the file. |  |
| 4 | Select the first line |  |
| 5 | Shift-Enter | The line will execute. |
| 6 | Repeat until the last line. |  |
| 7 | Ctrl-Enter | The cursor stays on the current line. |


## runtests.jl

It is even better to put you test code in the file `runtests.jl`. The folder `test` contains the file.

```
using Accounts
using Test

import Accounts: Domain
using .Domain

@testset "Domain.jl" begin
    donald_email = Address(EMAIL, "donald@duckcity.com")
    donald = Person("Donald duck", [donald_email])
    email_addresses = filter(x -> x.address_type == EMAIL, donald.addresses)
    @test email_addresses[1].address == "donald@duckcity.com"
end
```

## Activity 3.6 - runtests.jl

You will:
- Add unit test code to the file `runtests.jl`.
- Test the module `Accounts`.

#### Prerequisites
- The previous activity 3.4

Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | $ atom . | Start Atom/Juno. |
| 2 | Select the folder: `test` | Open the folder with runtests.jl. |

```
·µ•üìÅ Accounts
   üìÅ src
  ·µ•üìÅ test
     üìÑ runtests.jl
```

Step | Action | Comment |
| :--- | :--- | :--- |
| 3 | Open file: `runtests.jl` | Open the file.|
| 4 | Copy and paste the code from section runtests.jl | See: [runtests.jl](#runtests.jl-1) |
| 5 | Ctrl-S | Save the file. |
| 6 | julia> ] | Activate the package manager. |
| 7 | pkg> activate . | Activate the Accounts environment. |
| 8 | (Accounts) Pkg> st | Check whether Dates is loaded. See [Activity 3.4 - Adding Dates as Dependency](#Activity-3.4-Adding-Dates-as-Dependency-1). |
| 9 | (Accounts) Pkg> test Accounts | Run the test code. The result is: |

```
Test Summary: | Pass  Total
Domain.jl     |    1      1
    Testing Accounts tests passed
```

## Activity 3.7 - Update your GitHub Repository

It is time to push our changes to the GitHub repository. The easiest way is to use Atom/Juno. The Git pane have to be visible.

#### Prerequisites
- The previous activity 3.6

Step | Action | Comment |
| :--- | :--- | :--- |
| 1 | Shift+Ctrl-9 | Open the Git-pane when it is not visible. |
| 2 | Place your cursor in the field `Commit message` |  |
| 3 | Type: Add Domain.jl sub-module |  |
| 4 | Stage the changed files | Click on `Stage All` in the upper right corner of the Git-pane. |

You see a list of changed (ocher) and new (green) files (Domain.jl and test_domain.jl) in the section `Staged Changes` of the pane.

```
Project.toml
src/Accounts.jl
src/Domain.jl
src/test_domain.jl
test/runtests.jl
```

Step | Action | Comment |
| :--- | :--- | :--- |
| 5 | Click on: Commit to master |  |
| 6 | Click on the `Push` button | The Push-button is located at the lower right corner. |
| 7 | Go to GitHub and check whether your changes are visible |  |
